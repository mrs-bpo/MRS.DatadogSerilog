name: CI/CD Pipeline

on:
  push:
    branches: [ master, main, 'feature/*' ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  DOTNET_VERSION: '2.0.x'
  PACKAGE_NAME: 'MRS.DatadogSerilog'
  GITHUB_FEED: https://nuget.pkg.github.com/mrs-bpo/index.json
  TARGET_FRAMEWORKS: 'netstandard2.0'

jobs:
  detect-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version-type: ${{ steps.version.outputs.version-type }}
      is-prerelease: ${{ steps.version.outputs.is-prerelease }}
      should-publish: ${{ steps.version.outputs.should-publish }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Detect version and changes
        id: version
        run: |
          chmod +x ./scripts/detect-version.sh
          chmod +x ./scripts/analyze-breaking-changes.sh
          ./scripts/detect-version.sh "${{ github.event_name }}" "${{ github.ref_name }}" "${{ github.event_name == 'pull_request' }}"

      - name: Output version info
        run: |
          echo "Detected version: ${{ steps.version.outputs.version }}"
          echo "Version type: ${{ steps.version.outputs.version-type }}"
          echo "Is prerelease: ${{ steps.version.outputs.is-prerelease }}"
          echo "Should publish: ${{ steps.version.outputs.should-publish }}"

  build:
    needs: detect-version
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dotnet-version: ['6.0.x', '7.0.x']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: Configure GitHub Packages feed
        run: |
          dotnet nuget remove source github || true
          dotnet nuget add source "${{ env.GITHUB_FEED }}" \
            --name github \
            --username "${{ github.actor }}" \
            --password "${{ secrets.GITHUB_TOKEN }}" \
            --store-password-in-clear-text

      - name: Restore dependencies
        run: dotnet restore ./MRS.DatadogSeriLog.sln --source "${{ env.GITHUB_FEED }}" --source https://api.nuget.org/v3/index.json

      - name: Build solution
        run: dotnet build ./MRS.DatadogSeriLog.sln --configuration Release --no-restore

      - name: dotnet --info
        run: dotnet --info

  update-version-and-publish:
    needs: [detect-version, build]
    runs-on: ubuntu-latest
    if: needs.detect-version.outputs.should-publish == 'true' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Configure GitHub Packages feed
        run: |
          dotnet nuget remove source github || true
          dotnet nuget add source "${{ env.GITHUB_FEED }}" \
            --name github \
            --username "${{ github.actor }}" \
            --password "${{ secrets.GITHUB_TOKEN }}" \
            --store-password-in-clear-text

      - name: Update version metadata
        run: |
          chmod +x ./scripts/update-version-and-publish.sh
          ./scripts/update-version-and-publish.sh \
            "${{ needs.detect-version.outputs.version }}" \
            "${{ needs.detect-version.outputs.version-type }}" \
            "${{ needs.detect-version.outputs.is-prerelease }}" \
            "${{ env.PACKAGE_NAME }}"

      - name: Pack NuGet package
        run: |
          mkdir -p build/packages
          dotnet pack ./MRS.DatadogSeriLog.sln \
            -c Release \
            -p:PackageVersion='${{ needs.detect-version.outputs.version }}' \
            -p:IncludeSymbols=true \
            -p:SymbolPackageFormat=snupkg \
            -o build/packages

      - name: List created package files (debug)
        run: ls -la build/packages || true

      - name: Push package(s) to GitHub Packages
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          shopt -s nullglob
          for package in build/packages/*.nupkg; do
            # Skip symbol packages as they'll be pushed with main packages
            if [[ "$package" != *.symbols.nupkg ]]; then
              echo "Pushing $package"
              dotnet nuget push "$package" \
                --api-key "$NUGET_AUTH_TOKEN" \
                --source "github" \
                --skip-duplicate
            fi
          done

